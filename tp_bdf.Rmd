---
title: "Modèles mixtes"
subtitle: "TP3: `BodyWeight`"
author: "Florent Chuffart"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
---


```{r, echo=FALSE, eval=TRUE}
knitr::opts_chunk$set(collapse=TRUE, comment = "#>", fig.width=9, fig.height=6, eval=TRUE, echo=TRUE, results="verbatim", warning=FALSE)
```
# Data

J’étudie le jeux de données suivant : 

```{r, eval=TRUE, echo=TRUE, results="verbatim"}
d = nlme::bdf
head(d)
d$schoolNR     = factor(d$schoolNR, levels=unique(d$schoolNR), order=FALSE)
dim(d)
layout(1, respect=TRUE)
plot(langPOST~IQ.verb, d, col=d$schoolNR, pch=as.numeric(d$schoolNR))
table(d$schoolNR)

```

*STAT DESC*

1. Mettre les titres et les légendes des graphiques.





# Modèles

## Modèles lineaires classiques

Je construis les modèles suivants : 

```{r}
m0 = lm(langPOST~IQ.verb, d)
m1 = lm(langPOST~IQ.verb+schoolNR, d)
m2 = lm(langPOST~IQ.verb*schoolNR, d)
```



1. J’écris la formule analytique des modèles proposés ;
2. Je visualise les droites de régression et le graphique des prédictions de chacun des modèles ;
3. J’étudie la distribution des résidus ; 
4. Je valide les hypothèses des modèles ;


```{r lm}
layout(1, respect=TRUE)

m0 = lm(langPOST~IQ.verb, d)
summary(m0)
plot(langPOST~IQ.verb, d, pch=16, col=d$schoolNR, lty=as.numeric(d$schoolNR))
abline(m0)

m1 = lm(langPOST~IQ.verb+schoolNR, d)
summary(m1)
plot(langPOST~IQ.verb, d, pch=16, col=d$schoolNR, lty=as.numeric(d$schoolNR))
abline(a=m1$coef[1]             , b=m1$coef[2], col=1)
n = length(levels(d$schoolNR))
for (i in 2:n) {
  abline(a=m1$coef[1] + m1$coef[i+1], b=m1$coef[2], col=i)  
}


m2 = lm(langPOST~IQ.verb*schoolNR, d)
summary(m2)
plot(langPOST~IQ.verb, d, pch=16, col=d$schoolNR, lty=as.numeric(d$schoolNR))
abline(a=m2$coef[1]             , b=m2$coef[2]              , col=1)
n = length(levels(d$schoolNR))
for (i in 2:n) {
  abline(a=m2$coef[1] + m2$coef[i+1], b=m2$coef[2] + m2$coef[n+i] , col=i)
}
# abline(a=m2$coef[1] + m2$coef[3], b=m2$coef[2] + m2$coef[7] , col=2)
# abline(a=m2$coef[1] + m2$coef[4], b=m2$coef[2] + m2$coef[8] , col=3)
# abline(a=m2$coef[1] + m2$coef[5], b=m2$coef[2] + m2$coef[9] , col=4)
# abline(a=m2$coef[1] + m2$coef[6], b=m2$coef[2] + m2$coef[10], col=5)

```


## Modèles mixtes

Je construis les modèles suivants : 

(effet aléatoire sur l’ordonnée à l’origine et sur la pente)


```{r}
m4 = lme4::lmer(langPOST ~ IQ.verb + (IQ.verb | schoolNR), data=d)
```

1. J’écris la formule analytique des modèles proposés ;
2. Je visualise les droites de régression et le graphique des prédictions de chacun des modèles ;
3. J’étudie la distribution des résidus ; 
4. Je valide les hypothèses des modèles ;



```{r lme}
layout(1, respect=TRUE)


m4 = lme4::lmer(langPOST ~ IQ.verb + (IQ.verb | schoolNR), data=d)
summary(m4)
coef(m4)
plot(langPOST~IQ.verb, d, pch=16, col=d$schoolNR, lty=as.numeric(d$schoolNR))
n = length(levels(d$schoolNR))
for (i in 1:n) {
  abline(a=coef(m4)$schoolNR[i,1], b=coef(m4)$schoolNR[i,2], col=i)
}
```



Je construis les modèles suivants : 

(effet aléatoire uniquement sur l’ordonnée à l’origine ou  effet aléatoire uniquement sur la pente)

```{r}
m6 = lme4::lmer(langPOST ~ IQ.verb + (1 | schoolNR), data = d)
m8 = lme4::lmer(langPOST ~ IQ.verb + (0+IQ.verb | schoolNR), data = d)
```

1. J’écris la formule analytique des modèles proposés ;
2. Je visualise les droites de régression et le graphique des prédictions de chacun des modèles ;
3. J’étudie la distribution des résidus ; 
4. Je valide les hypothèses des modèles ;


```{r}
layout(1, respect=TRUE)

m6 = lme4::lmer(langPOST ~ IQ.verb + (1 | schoolNR), data = d)
summary(m6)
coef(m6)
plot(langPOST~IQ.verb, d, pch=16, col=d$schoolNR, lty=as.numeric(d$schoolNR))
n = length(levels(d$schoolNR))
for (i in 1:n) {
  abline(a=coef(m6)$schoolNR[i,1], b=coef(m6)$schoolNR[i,2], col=i)
}

m8 = lme4::lmer(langPOST ~ IQ.verb + (0+IQ.verb | schoolNR), data = d)
summary(m8)
coef(m8)
plot(langPOST~IQ.verb, d, pch=16, col=d$schoolNR, lty=as.numeric(d$schoolNR))
for (i in 1:n) {
  abline(a=coef(m8)$schoolNR[i,1], b=coef(m8)$schoolNR[i,2], col=i)
}
```



## Choix de modèles


```{r}
BIC(m0)
BIC(m1)
BIC(m2)
BIC(m4)
BIC(m6)
BIC(m8)
```


# Conclusion

1. Conclure

# Session Information

```{r results="verbatim"}
sessionInfo()
```

